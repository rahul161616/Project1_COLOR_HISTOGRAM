import os
import cv2
import numpy as np
import joblib
import matplotlib.pyplot as plt
from sklearn.metrics import confusion_matrix, classification_report, accuracy_score

# Feature extraction function
def extract_color_histogram(image_path, bins=32):
    image = cv2.imread(image_path)
    image = cv2.resize(image, (256, 256))
    b, g, r = cv2.split(image)
    hist_r = cv2.normalize(cv2.calcHist([r],[0],None,[bins],[0,256]), None).flatten()
    hist_g = cv2.normalize(cv2.calcHist([g],[0],None,[bins],[0,256]), None).flatten()
    hist_b = cv2.normalize(cv2.calcHist([b],[0],None,[bins],[0,256]), None).flatten()
    return np.concatenate([hist_r, hist_g, hist_b])

# Load trained model
knn = joblib.load("../knn_color_hist_model.pkl")  # adjust path if needed

# Dataset path
dataset_path = "../dataset"
classes = ["class1", "class2"]

y_true = []
y_pred = []

# Store images for visualization
images_class1 = []
images_class2 = []

# Loop through all images and predict
for label, class_name in enumerate(classes):
    class_dir = os.path.join(dataset_path, class_name)
    image_files = [f for f in os.listdir(class_dir) if f.endswith((".jpg", ".png", ".webp"))]

    for img_file in image_files:
        img_path = os.path.join(class_dir, img_file)
        features = extract_color_histogram(img_path).reshape(1, -1)
        pred = knn.predict(features)[0]

        y_true.append(label)
        y_pred.append(pred)

        # Save image for plotting
        img = cv2.imread(img_path)
        img = cv2.cvtColor(cv2.resize(img, (64, 64)), cv2.COLOR_BGR2RGB)
        if label == 0:
            images_class1.append((img, pred))
        else:
            images_class2.append((img, pred))

# Convert to numpy arrays
y_true = np.array(y_true)
y_pred = np.array(y_pred)

# Accuracy and classification report
accuracy = accuracy_score(y_true, y_pred)
print(f"Overall Accuracy: {accuracy*100:.2f}%\n")
print("Classification Report:")
print(classification_report(y_true, y_pred, target_names=classes))

# Confusion Matrix
cm = confusion_matrix(y_true, y_pred)
print("Confusion Matrix:")
print(cm)

# Plot confusion matrix
plt.figure(figsize=(5,5))
plt.imshow(cm, cmap=plt.cm.Blues)
plt.colorbar()
plt.xticks([0,1], classes)
plt.yticks([0,1], classes)
plt.xlabel("Predicted")
plt.ylabel("Actual")
plt.title("Confusion Matrix")
plt.show()

# Function to plot sample images with predictions
def plot_sample_images(images, class_name):
    plt.figure(figsize=(12,4))
    for i, (img, pred) in enumerate(images[:8]):  # plot first 8 images
        plt.subplot(2,4,i+1)
        plt.imshow(img)
        plt.axis('off')
        plt.title(f"Pred: {classes[pred]}")
    plt.suptitle(f"Sample images from {class_name}")
    plt.show()

plot_sample_images(images_class1, classes[0])
plot_sample_images(images_class2, classes[1])

# Predict a single provided image
provided_image = "import os
import cv2
import numpy as np
import joblib
import matplotlib.pyplot as plt
from sklearn.metrics import confusion_matrix, classification_report, accuracy_score

# Feature extraction function
def extract_color_histogram(image_path, bins=32):
    image = cv2.imread(image_path)
    image = cv2.resize(image, (256, 256))
    b, g, r = cv2.split(image)
    hist_r = cv2.normalize(cv2.calcHist([r],[0],None,[bins],[0,256]), None).flatten()
    hist_g = cv2.normalize(cv2.calcHist([g],[0],None,[bins],[0,256]), None).flatten()
    hist_b = cv2.normalize(cv2.calcHist([b],[0],None,[bins],[0,256]), None).flatten()
    return np.concatenate([hist_r, hist_g, hist_b])

# Load trained model
knn = joblib.load("../knn_color_hist_model.pkl")  # adjust path if needed

# Dataset path
dataset_path = "../dataset"
classes = ["class1", "class2"]

y_true = []
y_pred = []

# Store images for visualization
images_class1 = []
images_class2 = []

# Loop through all images and predict
for label, class_name in enumerate(classes):
    class_dir = os.path.join(dataset_path, class_name)
    image_files = [f for f in os.listdir(class_dir) if f.endswith((".jpg", ".png", ".webp"))]

    for img_file in image_files:
        img_path = os.path.join(class_dir, img_file)
        features = extract_color_histogram(img_path).reshape(1, -1)
        pred = knn.predict(features)[0]

        y_true.append(label)
        y_pred.append(pred)

        # Save image for plotting
        img = cv2.imread(img_path)
        img = cv2.cvtColor(cv2.resize(img, (64, 64)), cv2.COLOR_BGR2RGB)
        if label == 0:
            images_class1.append((img, pred))
        else:
            images_class2.append((img, pred))

# Convert to numpy arrays
y_true = np.array(y_true)
y_pred = np.array(y_pred)

# Accuracy and classification report
accuracy = accuracy_score(y_true, y_pred)
print(f"Overall Accuracy: {accuracy*100:.2f}%\n")
print("Classification Report:")
print(classification_report(y_true, y_pred, target_names=classes))

# Confusion Matrix
cm = confusion_matrix(y_true, y_pred)
print("Confusion Matrix:")
print(cm)

# Plot confusion matrix
plt.figure(figsize=(5,5))
plt.imshow(cm, cmap=plt.cm.Blues)
plt.colorbar()
plt.xticks([0,1], classes)
plt.yticks([0,1], classes)
plt.xlabel("Predicted")
plt.ylabel("Actual")
plt.title("Confusion Matrix")
plt.show()

# Function to plot sample images with predictions
def plot_sample_images(images, class_name):
    plt.figure(figsize=(12,4))
    for i, (img, pred) in enumerate(images[:8]):  # plot first 8 images
        plt.subplot(2,4,i+1)
        plt.imshow(img)
        plt.axis('off')
        plt.title(f"Pred: {classes[pred]}")
    plt.suptitle(f"Sample images from {class_name}")
    plt.show()

plot_sample_images(images_class1, classes[0])
plot_sample_images(images_class2, classes[1])

# Predict a single provided image
provided_image = "provided_image.jpg"  # replace with your image path
features = extract_color_histogram(provided_image).reshape(1,-1)
pred = knn.predict(features)[0]

img = cv2.imread(provided_image)
img = cv2.cvtColor(cv2.resize(img, (256,256)), cv2.COLOR_BGR2RGB)
plt.imshow(img)
plt.axis('off')
plt.title(f"Prediction for Provided Image: {classes[pred]}")
plt.show()
"  # replace with your image path
features = extract_color_histogram(provided_image).reshape(1,-1)
pred = knn.predict(features)[0]

img = cv2.imread(provided_image)
img = cv2.cvtColor(cv2.resize(img, (256,256)), cv2.COLOR_BGR2RGB)
plt.imshow(img)
plt.axis('off')
plt.title(f"Prediction for Provided Image: {classes[pred]}")
plt.show()
